<!Doctype html>
<html lang="ko">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- JS -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
        integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN"
        crossorigin="anonymous"></script>

    <!-- êµ¬ê¸€í°íŠ¸ -->
    <link href="https://fonts.googleapis.com/css?family=Stylish&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Leaflet Routing Machine -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.min.js"></script>

    <title>ëª¨ì§‘ê¸€ ìƒì„¸</title>

    <!-- style -->
    <style type="text/css">
        .leaflet-routing-container {
            display: none;
        }

        :root {
            --bg: #f6f7fb;
            --panel: #ffffff;
            --border: #e6e8ee;
            --text: #111827;
            --muted: #6b7280;
            --primary: #3b82f6;
            --primary-600: #2563eb;
            --danger: #ef4444;
            --danger-600: #dc2626;
            --accent: #6366f1;
            --shadow: 0 6px 24px rgba(20, 26, 38, 0.06);
            --radius: 14px;
            --radius-sm: 10px;
            --ring: 0 0 0 4px rgba(59, 130, 246, 0.14);
        }

        * {
            /* font-family: "Stylish", sans-serif; */
            /* margin: 0 1rem 0 1rem; */
            box-sizing: border-box;
        }

        body {
            margin: 0;
            background: var(--bg);
            color: var(--text);
            font: 14px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Noto Sans KR, Pretendard, Apple SD Gothic Neo, Arial, sans-serif;
        }

        /* ì»¨í…Œì´ë„ˆ */
        .app {
            max-width: 1160px;
            margin: 40px auto;
            padding: 24px;
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }

        .page-scope .btn {
            appearance: none;
            border: 1px solid var(--border);
            background: #fff;
            color: #111827;
            padding: 9px 12px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: box-shadow .15s ease, transform .06s ease, border-color .15s ease;
        }

        .page-scope .btn:hover {
            border-color: #cbd5e1;
            box-shadow: var(--ring)
        }

        .page-scope .btn:active {
            transform: translateY(1px)
        }

        .page-scope .btn-primary {
            background: var(--primary);
            border-color: transparent;
            color: #fff;
        }

        .page-scope .btn-primary:hover {
            box-shadow: var(--ring);
            background: var(--primary-600)
        }

        .btn-danger {
            background: #fff;
            color: var(--danger);
            border-color: #ffd2d2;
        }

        .btn-danger:hover {
            border-color: #ffb4b4;
            box-shadow: 0 0 0 4px rgba(239, 68, 68, .12)
        }

        .btn-danger:active {
            background: #fff5f5
        }

        /* -------------------------------------------------
            í¼ ì˜ì—­
            ------------------------------------------------- */
        .form {
            margin-top: 20px;
            padding: 16px;
            background: #fff;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            box-shadow: var(--shadow);
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 14px 20px;
        }

        .field {
            display: flex;
            /*flex-direction:column;*/
            gap: 8px
        }

        .label {
            width: 15%;
            font-size: 13px;
            color: var(--muted);
            font-weight: 700;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .input,
        .select,
        .date,
        .readonly {
            width: 60%;
            padding: 11px 12px;
            border: 1px solid var(--border);
            border-radius: 10px;
            background: #fff;
            color: #111827;
            outline: none;
            transition: border-color .15s ease, box-shadow .15s ease;
        }

        .input:focus,
        .select:focus,
        .date:focus {
            border-color: #c4d3ff;
            box-shadow: var(--ring);
        }

        .readonly {
            background: #fafafa;
            color: #6b7280;
        }

        /* í…ìŠ¤íŠ¸ ì˜ì—­ */
        .editor {
            margin-top: 16px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .textarea {
            width: 100%;
            min-height: 260px;
            resize: vertical;
            padding: 12px 14px;
            border: 1px solid var(--border);
            border-radius: 12px;
            background: #fff;
            outline: none;
            transition: border-color .15s ease, box-shadow .15s ease;
        }

        .textarea::placeholder {
            color: #9da3ae
        }

        .textarea:focus {
            border-color: #c4d3ff;
            box-shadow: var(--ring)
        }

        /* í•˜ë‹¨ ë²„íŠ¼ */
        .form-actions {
            margin-top: 16px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .btn-ghost {
            background: #fff;
            border: 1px solid var(--border);
            color: #111827;
        }

        .btn-ghost:hover {
            border-color: #cbd5e1;
            box-shadow: var(--ring)
        }

        .btn-solid {
            background: var(--accent);
            color: #fff;
            border: 1px solid transparent;
        }

        .btn-solid:hover {
            background: #5558e6;
            box-shadow: var(--ring)
        }

        /* ì´ë¯¸ì§€ì— ë„í˜•ê·¸ë¦¬ê¸° */
        #wrap {
            position: relative;
            display: inline-block;
        }

        #map {
            height: 400px;
            /* ì§€ë„ì˜ ë†’ì´ë¥¼ ë°˜ë“œì‹œ ì§€ì •í•´ì•¼ í•©ë‹ˆë‹¤. */
            width: 100%;
        }

        #map1 {
            height: 400px;
            /* ì§€ë„ì˜ ë†’ì´ë¥¼ ë°˜ë“œì‹œ ì§€ì •í•´ì•¼ í•©ë‹ˆë‹¤. */
            width: 100%;
        }

        #map2 {
            height: 400px;
            /* ì§€ë„ì˜ ë†’ì´ë¥¼ ë°˜ë“œì‹œ ì§€ì •í•´ì•¼ í•©ë‹ˆë‹¤. */
            width: 100%;
        }

        #mapImg {
            display: block;
            max-width: 100%;
            height: auto;
            user-select: none;
        }

        .container {
            display: flex;
            align-items: flex-start;
            /* ìœ„ìª½ ë§ì¶¤ */
            gap: 20px;
            /* ì´ë¯¸ì§€ì™€ ë²„íŠ¼ ì‚¬ì´ ê°„ê²© */
        }

        /* ì˜¤ë²„ë ˆì´ë¥¼ CSSë¡œ ì´ë¯¸ì§€ ìœ„ì— 'ê°€ë“' ë®ê¸°: inset:0ë¡œ JS ì‚¬ì´ì¦ˆ ì˜ì¡´ ì œê±° */
        #overlay {
            position: absolute;
            inset: 0;
            z-index: 5;
            pointer-events: auto;
            cursor: default;
        }

        .rect {
            position: absolute;
            border: 2px solid rgb(170, 0, 113);
            background: rgba(196, 9, 140, 0.705);
            box-sizing: border-box;
        }

        .rect.selected {
            border-color: #ff4d4f;
            box-shadow: 0 0 0 2px rgba(255, 77, 79, .35);
        }

        .toolbar {
            margin: 10px 0;
            display: flex;
            gap: 8px;
            justify-content: flex-end;
            flex-direction: column;
        }

        .toolbar button {
            padding: 6px 10px;
        }

        .btnList {
            display: none !important;
        }

        .btnList.show {
            display: flex !important;
        }

        /* ìœ íš¨ì„± ê²€ì‚¬ css */
        .is-invalid {
            border-color: #ef4444 !important;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, .15) !important;
        }

        .invalid-msg {
            margin-top: 6px;
            font-size: 12px;
            color: #ef4444;
        }
    </style>

    <script>
        $(document).ready(function () {
            let msg = "{{ msg }}";
            console.log("msg : " + msg);
            if (msg != 'None' && msg != 'undefiened' != msg != null) {
                alert(msg);
            }
        });

        var rects = [];
        var autoId = 0;
        // ì´ë¯¸ì§€ì— ë„í˜• ê·¸ë¦¬ê¸°
        $(function () {
            const el = document.getElementById('overlay');
            if (!el) { console.error('#overlay not found'); return; }

            // data-shapes íŒŒì‹±
            const raw = el.getAttribute('data-shapes') || '[]';
            let SAVED_SHAPES = [];
            try { SAVED_SHAPES = raw.trim() ? JSON.parse(raw) : []; } catch { /* ignore */ }

            const $img = $('#mapImg');
            if ($img.length === 0) {                 // â† ì—¬ê¸°ì„œ ì•ˆì „ ì²´í¬
                console.error('#mapImg not found');
                return;
            }

            // ì´ë¯¸ì§€ê°€ ì´ë¯¸ ìºì‹œ ë¡œë“œëìœ¼ë©´ ë°”ë¡œ, ì•„ë‹ˆë©´ load í›„ì—
            if ($img.prop('complete') && $img[0].naturalWidth) {
                drawNow();
            } else {
                $img.one('load', drawNow);
            }
            $(window).on('resize', drawNow);

            function drawNow() {
                const overlay = document.getElementById('overlay');
                if (!overlay) return;

                const W = overlay.clientWidth;
                const H = overlay.clientHeight;
                if (!W || !H) return;  // í¬ê¸° 0ì´ë©´ ê·¸ë ¤ë„ ì•ˆ ë³´ì„

                overlay.innerHTML = '';
                SAVED_SHAPES.forEach(s => {
                    const div = document.createElement('div');
                    div.className = 'rect';
                    div.style.position = 'absolute';
                    div.style.boxSizing = 'border-box';
                    div.style.border = '2px solid rgb(170, 0, 113)';
                    div.style.background = 'rgba(196, 9, 140, 0.705)';
                    div.style.left = (s.x * W) + 'px';
                    div.style.top = (s.y * H) + 'px';
                    div.style.width = (s.w * W) + 'px';
                    div.style.height = (s.h * H) + 'px';
                    overlay.appendChild(div);
                    $('.rect').data('id', (++autoId).toString());
                });
            }


            // ìˆ˜ì • ê¶Œí•œ ìˆì„ ê²½ìš°
            if ("{{isMyPost}}" != 'False') {
                $('.btnList').addClass('show');

                const $overlay = $('#overlay');
                let mode = 'idle';              // 'idle' | 'draw' | 'select'
                let drawing = false, start = { x: 0, y: 0 };
                let $current = null, selectedId = null


                function setMode(next) {
                    mode = next;
                    if (mode === 'draw') {
                        $('#btnDraw').text('ê·¸ë¦¬ê¸° ì¢…ë£Œ (Esc)');
                        $overlay.css('cursor', 'crosshair');
                    } else {
                        $('#btnDraw').text('ì˜ì—­(ì‚¬ê°í˜•) í‘œì‹œ');
                        $overlay.css('cursor', 'default');
                        cancelCurrentDrawing();
                    }
                    clearSelection();
                }
                $('#btnDraw').on('click', () => setMode(mode === 'draw' ? 'idle' : 'draw'));

                // overlay ê¸°ì¤€ ìƒëŒ€ì¢Œí‘œ(ìŠ¤í¬ë¡¤ ì•ˆì „)
                function relPos(e) {
                    const off = $overlay.offset();
                    return { x: e.pageX - off.left, y: e.pageY - off.top };
                }

                // ë“œë¡œì‰
                $overlay.on('mousedown', function (e) {
                    console.log("mouse down");
                    if (mode !== 'draw') return;
                    drawing = true;
                    start = relPos(e);
                    $current = $('<div class="rect"></div>').css({
                        left: start.x, top: start.y, width: 0, height: 0
                    }).appendTo($overlay);
                    $current.data('id', (++autoId).toString());
                });

                $(document).on('mousemove', function (e) {
                    if (!drawing || !$current) return;
                    const p = relPos(e);
                    const x = Math.min(p.x, start.x);
                    const y = Math.min(p.y, start.y);
                    const w = Math.abs(p.x - start.x);
                    const h = Math.abs(p.y - start.y);
                    $current.css({ left: x, top: y, width: w, height: h });
                });

                $(document).on('mouseup', function () {
                    console.log("mouse up");
                    if (!drawing || !$current) return;
                    drawing = false;

                    const x = parseFloat($current.css('left'));
                    const y = parseFloat($current.css('top'));
                    const w = parseFloat($current.css('width'));
                    const h = parseFloat($current.css('height'));
                    if (w < 3 || h < 3) { $current.remove(); $current = null; return; }

                    rects.push({ id: $current.data('id'), x, y, w, h });
                    $current = null;
                });

                // ì„ íƒ/í•´ì œ
                $overlay.on('click', '.rect', function (e) {
                    console.log("rect Clicked!! ì„ íƒ ");
                    if (mode === 'draw') return;
                    e.stopPropagation();
                    const $r = $(this), id = $r.data('id');
                    console.log("id : " + id);

                    if (selectedId === id) { clearSelection(); return; }
                    clearSelection(); selectedId = id; $r.addClass('selected'); mode = 'select';
                });
                $overlay.on('click', function (e) {
                    console.log("rect Clicked!! í•´ì œ");
                    if ($(e.target).hasClass('rect')) return;
                    clearSelection(); if (mode === 'select') mode = 'idle';
                });
                function clearSelection() { selectedId = null; $overlay.find('.rect').removeClass('selected'); }
                function cancelCurrentDrawing() { drawing = false; if ($current) { $current.remove(); $current = null; } }

                // ì‚­ì œ/ì´ˆê¸°í™”
                $('#btnDelete').on('click', function () {
                    if (!selectedId) return;
                    $overlay.find(`.rect`).each(function () {
                        console.log("this.id : " + $(this).data('id'));
                        console.log("selected id : " + selectedId);
                        if ($(this).data('id') === selectedId) $(this).remove();
                    });
                    rects = rects.filter(r => r.id !== selectedId); clearSelection(); mode = 'idle';
                });
                $('#btnClear').on('click', function () {
                    rects = []; $overlay.find('.rect').remove(); clearSelection(); cancelCurrentDrawing(); setMode('idle');
                });

            }

        });
        // ì¹´í…Œê³ ë¦¬ selectBox ì„ íƒì‹œ í™”ë©´ ìœ í˜• ì „í™˜        
        $(function () {
            $(".category").hide();  // ì¹´í…Œê³ ë¦¬ë³„ í™”ë©´ ìˆ¨ê¸°ê³  ì‹œì‘
            category = $("#categorySelect").val();
            if (category == 'ì‹œì„¤ì´ìš©') {
                $("#1").show();

                if ($("#facility").val() == 'êµìœ¡ì¥' || $("#facility").val() == 'íšŒì˜ì‹¤') {
                    $("#facilityDetail").show();
                }
            }
            // ë‚´ ëª¨ì§‘ê¸€ì¼ ê²½ìš° ë°”ë¡œ ìˆ˜ì •ê°€ëŠ¥
            if ("{{isMyPost}}" != 'False' && ("{{post.statu}}" == '1')) {
                $('.editable').attr('readonly', false);
                $('#categorySelect').attr('disabled', false);
            }

            $("#categorySelect").on("change", function () {
                const selectValue = $(this).val();
                $(".category").hide();
            });

            $('#facility').on("change", function () {
                selectValue = $(this).val();
                if (selectValue == 'êµìœ¡ì¥' || selectValue == 'íšŒì˜ì‹¤') {
                    $("#facilityDetail").show();
                } else {
                    $("#facilityDetail").hide();
                }
            })
        });

        function showError($el, msg) {
            $el.addClass('is-invalid');
            const $wrap = $el.closest('.field').length ? $el.closest('.field') : $el.parent();
            if ($wrap.find('.invalid-msg').length === 0) {
                $('<div class="invalid-msg"></div>').text(msg).appendTo($wrap);
            } else {
                $wrap.find('.invalid-msg').text(msg);
            }
        }
        function clearError($el) {
            $el.removeClass('is-invalid');
            const $wrap = $el.closest('.field').length ? $el.closest('.field') : $el.parent();
            $wrap.find('.invalid-msg').remove();
        }


        function checkValid(categoryVal) {
            const $form = $('#info');

            // âœ… ì‚¬ìš©ìê°€ #info ë²„íŠ¼ì„ ëˆŒë €ì„ ë•Œ ìœ íš¨ì„± ê²€ì‚¬ ì‹¤í–‰
            let ok = true, $firstInvalid = null;

            const $title = $form.find('input[name="title"]');
            if (!$title.val() || !$title.val().trim()) {
                ok = false; showError($title, 'ì œëª©ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.'); if (!$firstInvalid) $firstInvalid = $title;
            } else clearError($title);

            const $required = $form.find('input[name="required"]');
            if (!$required.val() || !$required.val().trim()) {
                ok = false; showError($required, 'ëª¨ì§‘ì¸ì›ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.'); if (!$firstInvalid) $firstInvalid = $required;
            } else clearError($required);

            const $closing_date = $form.find('input[name="closing_date"]');
            const closeDateOk = /^\d{4}-\d{2}-\d{2}$/.test($closing_date.val() || '');
            if (!closeDateOk) {
                ok = false; showError($closing_date, 'ë§ˆê°ì¼ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.'); if (!$firstInvalid) $firstInvalid = $closing_date;
            } else clearError($closing_date);

            const $closing_time = $form.find('input[name="closing_time"]');
            // ì •ê·œì‹: 00:00 ~ 23:59 ê¹Œì§€ í—ˆìš©
            const closeTimeOk = /^([01]\d|2[0-3]):([0-5]\d)$/.test($closing_time.val() || '');

            if (!closeTimeOk) {
                ok = false;
                showError($closing_time, 'ë§ˆê° ì‹œê°„ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
                if (!$firstInvalid) $firstInvalid = $closing_time;
            } else {
                clearError($closing_time);
            }

            const $start_date = $form.find('input[name="start_date"]');
            const dateOk = /^\d{4}-\d{2}-\d{2}$/.test($start_date.val() || '');
            if (!dateOk) {
                ok = false; showError($start_date, 'ì‹œì‘ì¼ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.'); if (!$firstInvalid) $firstInvalid = $start_date;
            } else clearError($start_date);

            const $start_time = $form.find('input[name="start_time"]');
            // ì •ê·œì‹: 00:00 ~ 23:59 ê¹Œì§€ í—ˆìš©
            const timeOk = /^([01]\d|2[0-3]):([0-5]\d)$/.test($start_time.val() || '');

            if (!timeOk) {
                ok = false;
                showError($start_time, 'ì‹œì‘ ì‹œê°„ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
                if (!$firstInvalid) $firstInvalid = $start_time;
            } else {
                clearError($start_time);
            }

            const $content = $form.find('textarea[name="content"]');
            if (!$content.val() || !$content.val().trim()) {
                ok = false; showError($content, 'ë‚´ìš©ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.'); if (!$firstInvalid) $firstInvalid = $content;
            } else clearError($content);

            /* ì¹´í…Œê³ ë¦¬ë³„ ê²€ì‚¬ ë‹¤ë¥´ê²Œ */
            if (categoryVal == 'ì‹œì„¤ì´ìš©') {
                const $facility = $('#facility');
                if ($facility.val() == '0') {
                    ok = false; showError($facility, 'ì‹œì„¤ë¬¼ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.'); if (!$firstInvalid) $firstInvalid = $facility;
                } else clearError($facility);
            }

            if (!ok) {
                const el = $firstInvalid[0];
                el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                $firstInvalid.focus();
                return false; // âŒ ì œì¶œí•˜ì§€ ì•ŠìŒ
            }


            return true;
        }

        function doApply() {
            // ì§€ì› í•˜ê³  ë‚˜ë©´ ë§ˆì´í˜ì´ì§€ë¡œ ì´ë™
            const form = document.getElementById("info");
            form.submit();
        }


        function goMain() {
            location.href = '/';
        }

        function doCancel() {
            const form = document.getElementById("info");
            form.action = '/post/cancel/{{post._id}}'
            form.submit();
        }

        function doClose() {
            const form = document.getElementById("info");
            const result = confirm('ë§ˆê°ì²˜ë¦¬ í•˜ì‹œë©´ ì·¨ì†Œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë§ˆê°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');

            if (result) {
                const form = document.getElementById("info");
                form.action = '/post/close/{{post._id}}'
                form.submit();
            }
        }

        function doUpdate() {
            const form = document.getElementById("info");
            const categoryVal = $("#categorySelect").val();

            // ìœ íš¨ì„± ê²€ì‚¬ method
            if (!checkValid(categoryVal)) {
                return false;
            };

            const hidden = document.createElement("input");
            hidden.type = "hidden";
            hidden.name = "category";
            hidden.value = categoryVal;
            form.appendChild(hidden);

            if (categoryVal == 'ì‹œì„¤ì´ìš©') {     // ì‹œì„¤ì´ìš© : ê³µê°„ ì¢Œí‘œ, ì¹´í…Œê³ ë¦¬, ì¹´í…Œê³ ë¦¬ ìƒì„¸
                const facility = $("#facility").val();

                const hidden = document.createElement("input");
                hidden.type = "hidden";
                hidden.name = "facility";
                hidden.value = facility;
                form.appendChild(hidden);

                // ì´ë¯¸ì§€ ë„í˜• ì¢Œí‘œê°’
                const rect = document.createElement("input");
                hidden.type = "hidden";
                hidden.name = "rect";

                const $overlay = $('#overlay');
                const W = $overlay.width(), H = $overlay.height();
                const normalized = rects.map(r => ({ id: r.id, x: r.x / W, y: r.y / H, w: r.w / W, h: r.h / H }));
                hidden.value = JSON.stringify(normalized);
                form.appendChild(rect);

                if (facility == 'êµìœ¡ì¥' || facility == 'íšŒì˜ì‹¤') {
                    const hidden = document.createElement("input");
                    hidden.type = "hidden";
                    hidden.name = "facilityDetail";
                    hidden.value = facilityDetail;
                    form.appendChild(hidden);
                }
            }
            form.action = '/post/update/{{post._id}}'
            form.submit();
        }
        function doReply() {
            const userId = "{{session.get('user')}}";
            const replyContent = $("#reply_content").val();

            // ë¹„ë™ê¸° í†µì‹ ìœ¼ë¡œ insert
            $.ajax({
                url: '/ajax/reply',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    postId: "{{post._id}}",
                    userId: userId,
                    replyContent: replyContent,
                    created_at: new Date().toLocaleString('ko-KR', { timeZone: 'Asia/Seoul' })
                }),
                success: function (res) {
                    if (res.ok) {
                        // ì‚¬ìš©ì ì…ë ¥ì¹¸ ì´ˆê¸°í™”
                        $("#reply_content").val("");

                        // ì„œë²„ê°€ ë Œë”í•´ì¤€ HTML ì¡°ê°ì„ ê·¸ëŒ€ë¡œ ë¶™ì„
                        const r = res.data;
                        const tr = `<tr>
                                    <td>${r.userId}</td>
                                    <td>${r.replyContent}</td>
                                    <td>${r.created_at}</td>
                                    </tr>`;
                        $('#replyTable > tbody').last().append(tr);
                    } else {
                        alert("ì—¬ê¸°ë„ ì‹¤íŒ¨");
                    }
                },
                error: function (xhr) {
                    alert('ì‹¤íŒ¨: ' + (xhr.responseJSON?.message || xhr.statusText));
                }
            });

            // responseë¡œ í™”ë©´ì— append
            location.href = location.href;
        }

        document.addEventListener('DOMContentLoaded', function () {
            const runningMapElement = document.getElementById('map');
            const destMapElement = document.getElementById('map1');

            // ëª©ì ì§€ ë§µì´ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
            if (destMapElement) {
                // ì„œë²„ì—ì„œ ì „ë‹¬ëœ ìœ„ë„ì™€ ê²½ë„ ê°’ì„ ê°€ì ¸ì™€ ìˆ«ìë¡œ ë³€í™˜í•©ë‹ˆë‹¤.
                const destLat = parseFloat("{{post.dest_lat}}");
                const destLng = parseFloat("{{post.dest_lng}}");

                // ìœ íš¨í•œ ìˆ«ìì¸ì§€ í™•ì¸
                if (!isNaN(destLat) && !isNaN(destLng)) {
                    // map1 ìš”ì†Œë¥¼ ì‚¬ìš©í•˜ì—¬ Leaflet ì§€ë„ë¥¼ ì´ˆê¸°í™”í•˜ê³ , ë·°ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
                    const map = L.map('map1').setView([destLat, destLng], 16);

                    // OpenStreetMap íƒ€ì¼ ë ˆì´ì–´ë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                    }).addTo(map);

                    // ëª©ì ì§€ ìœ„ì¹˜ì— ë§ˆì»¤ë¥¼ ì¶”ê°€í•˜ê³  íŒì—…ì„ ë„ì›ë‹ˆë‹¤.

                    L.marker([destLat, destLng])
                        .addTo(map)
                        .bindPopup("<b>ëª©ì ì§€</b>")
                        .openPopup();
                } else {
                    // ìœ íš¨í•˜ì§€ ì•Šì€ ë°ì´í„°ì¸ ê²½ìš° ë§µ ìš”ì†Œë¥¼ ìˆ¨ê¹ë‹ˆë‹¤.
                    destMapElement.style.display = 'none';
                }
            }

            // ë§µ 1 (ëŸ¬ë‹/ì‚°ì±…)
            if (runningMapElement) {
                const runningPointsRaw = runningMapElement.textContent.trim();

                if (runningPointsRaw) {
                    try {
                        const runningPoints = JSON.parse(runningPointsRaw);
                        console.log(runningPoints)
                        const map = L.map('map').setView([runningPoints[0].lat, runningPoints[0].lng], 13);
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                        }).addTo(map);

                        runningPoints.forEach(point => {
                            L.marker([point.lat, point.lng])
                                .addTo(map)
                                .bindPopup(`<b>Running Point</b><br>Lat: ${point.lat}<br>Lng: ${point.lng}`);
                        });

                        const latlngs = runningPoints.map(point => [point.lat, point.lng]);
                        const polyline = L.polyline(latlngs, {
                            color: 'red'
                        }).addTo(map);

                        map.fitBounds(polyline.getBounds());

                    } catch (e) {
                        console.error("Failed to parse runningPoints:", e);
                    }
                } else {
                    // ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ë§µ ìš”ì†Œ ì‚­ì œ
                    runningMapElement.remove();
                }
            }
            // íƒì‹œ ë§µ ì´ˆê¸°í™”
            const taxiMapElement = document.getElementById('map2');
            const taxiDestinationElement = document.getElementById('taxi_destination_text');

            if (taxiMapElement && taxiDestinationElement) {
                const taxiDestination = taxiDestinationElement.textContent.trim();
                const startLatLng = [37.2697, 127.2078]; // ì¶œë°œì§€ ê³ ì •

                const matches = taxiDestination.match(/ìœ„ë„: ([\d.]+), ê²½ë„: ([\d.]+)/);
                if (matches && matches.length === 3) {
                    const lat = parseFloat(matches[1]);
                    const lng = parseFloat(matches[2]);

                    if (!isNaN(lat) && !isNaN(lng)) {
                        const destinationLatLng = [lat, lng];
                        const map = L.map('map2').setView(destinationLatLng, 16);

                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                        }).addTo(map);

                        L.marker(startLatLng).addTo(map).bindPopup("ì¶œë°œì§€").openPopup();
                        L.marker(destinationLatLng).addTo(map).bindPopup("ëª©ì ì§€").openPopup();

                        // ğŸ”½ ìµœë‹¨ ê²½ë¡œ ê·¸ë¦¬ê¸°
                        L.Routing.control({
                            waypoints: [L.latLng(startLatLng), L.latLng(destinationLatLng)],
                            routeWhileDragging: false,
                            createMarker: function () { return null; },
                            showAlternatives: false,
                            showInstructions: false,
                            lineOptions: { styles: [{ color: '#0066cc', weight: 5, opacity: 0.7 }] }
                        }).addTo(map);

                    } else {
                        console.error("Failed to parse latitude or longitude from the string.");
                        taxiMapElement.style.display = 'none';
                    }
                } else {
                    // ì£¼ì†Œ ê¸°ë°˜ ëª©ì ì§€ ì²˜ë¦¬
                    const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(taxiDestination)}&format=json&limit=1`;

                    fetch(url)
                        .then(response => response.json())
                        .then(data => {
                            if (data && data.length > 0) {
                                const lat = parseFloat(data[0].lat);
                                const lon = parseFloat(data[0].lon);
                                const destinationLatLng = [lat, lon];

                                // ê¸°ì¡´ ì§€ë„ ì´ˆê¸°í™”
                                const container = L.DomUtil.get('map2');
                                if (container != null) {
                                    container._leaflet_id = null;
                                }

                                const map = L.map('map2').setView(destinationLatLng, 16);
                                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                                }).addTo(map);

                                L.marker(startLatLng).addTo(map).bindPopup("ì¶œë°œì§€").openPopup();
                                L.marker(destinationLatLng).addTo(map).bindPopup("ëª©ì ì§€").openPopup();

                                // ğŸ”½ ìµœë‹¨ ê²½ë¡œ ê·¸ë¦¬ê¸°
                                L.Routing.control({
                                    waypoints: [L.latLng(startLatLng), L.latLng(destinationLatLng)],
                                    routeWhileDragging: false,
                                    createMarker: function () { return null; },
                                    showAlternatives: false,
                                    showInstructions: false,
                                    lineOptions: { styles: [{ color: '#0066cc', weight: 5, opacity: 0.7 }] }
                                }).addTo(map);

                            } else {
                                alert('ì£¼ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                            }
                        })
                        .catch(error => {
                            console.error('Error fetching data:', error);
                            alert('ì£¼ì†Œ ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                        });
                }
            }

        });
    </script>


</head>

<body>

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
        <div class="container-fluid">
            <div class="mx-auto">
                <a class="navbar-brand" href="/">WithMe</a>
            </div>
            <div class="d-flex">
                <a class="btn btn-outline-light me-2" href="/post/new">ìƒˆ ê¸€ ì‘ì„±</a>
                <a class="btn btn-outline-light me-2" href="/mypage">ë§ˆì´í˜ì´ì§€</a>
                <a class="btn btn-outline-light" href="/logout">ë¡œê·¸ì•„ì›ƒ</a>
            </div>
        </div>
    </nav>

    <div class="app page-scope">
        <div class="field" style="margin-bottom: 5%;">
            <label class="label">ì¹´í…Œê³ ë¦¬</label>
            <select class="select" id="categorySelect" disabled>
                <option {{ 'selected' if post.category=='ê¸°íƒ€' else '' }}>ê¸°íƒ€</option>
                <option {{ 'selected' if post.category=='ì‹œì„¤ì´ìš©' else '' }}>ì‹œì„¤ì´ìš©</option>
                <option {{ 'selected' if post.category=='ëŸ¬ë‹/ì‚°ì±…' else '' }}>ëŸ¬ë‹/ì‚°ì±…</option>
                <option {{ 'selected' if post.category=='ë°°ë‹¬' else '' }}>ë°°ë‹¬</option>
                <option {{ 'selected' if post.category=='ì™¸ì¶œ' else '' }}>ì™¸ì¶œ</option>
                <option {{ 'selected' if post.category=='íƒì‹œ' else '' }}>íƒì‹œ</option>
            </select>
        </div>

        <div class="category" id="1">
            <!-- ì¢Œì¸¡ : ê·¸ë¦¼ -->
            <div class="container">
                <div id="wrap" style="position:relative; display:inline-block; max-width: 50%;">
                    <img id="mapImg" src="{{ url_for('static', filename='campus_map.png') }}" draggable="false"
                        style="display: block; user-select: none;" alt="campus map">
                    <div id="overlay" style="position:absolute; left:0; top:0; z-index: 5; pointer-events:auto;"
                        data-shapes='{{ shapes_json | e }}'></div>
                </div>

                <!-- ìš°ì¸¡: ë²„íŠ¼ëª©ë¡ -->
                <div class="toolbar btnList">
                    <button id="btnDraw" class="btn btn-primary">ì˜ì—­(ì‚¬ê°í˜•) í‘œì‹œ</button>
                    <button id="btnDelete" class="btn btn-primary">ì„ íƒ ì‚­ì œ</button>
                    <button id="btnClear" class="btn btn-primary">ì „ì²´ ì‚­ì œ</button>
                    <!-- <button id="btnSave" class="btn btn-primary">ì €ì¥</button> -->
                </div>
                <div class="toolbar">
                    <select class="select" id="facility" style="width: 100%;" disabled>
                        <option value="0">ì‹œì„¤ë¬¼ ì„ íƒ</option>
                        <option {{ 'selected' if post.facility=='ì •ê¸€ìŠ¤í…Œì´ì§€' else '' }}>ì •ê¸€ìŠ¤í…Œì´ì§€</option>
                        <option {{ 'selected' if post.facility=='ì¹´í˜í…Œë¦¬ì•„' else '' }}>ì¹´í˜í…Œë¦¬ì•„</option>
                        <option {{ 'selected' if post.facility=='í¸ì˜ì ' else '' }}>í¸ì˜ì </option>
                        <option {{ 'selected' if post.facility=='íƒë°°ë³´ê´€ì†Œ' else '' }}>íƒë°°ë³´ê´€ì†Œ</option>
                        <option {{ 'selected' if post.facility=='í—¬ìŠ¤ì¥' else '' }}>í—¬ìŠ¤ì¥</option>
                        <option {{ 'selected' if post.facility=='ì„¸íƒì‹¤' else '' }}>ì„¸íƒì‹¤</option>
                        <option {{ 'selected' if post.facility=='êµìœ¡ì¥' else '' }}>êµìœ¡ì¥</option>
                        <option {{ 'selected' if post.facility=='íšŒì˜ì‹¤' else '' }}>íšŒì˜ì‹¤</option>
                    </select>
                    <input id="facilityDetail" class="input" type="text" placeholder="ìƒì„¸ì •ë³´"
                        style="width: 100%; display: none;" value="{{post.facilityDetail}}">
                </div>
            </div>

        </div>

        <!-- í¼ -->
        <form class="form" id="info" action="/post/participate/{{post._id}}" method="post">
            <input type="hidden" value="{{post._id}}" name="id">
            <div class="form-grid">
                <div class="field">
                    <label class="label">ì œëª©</label>
                    <input class="input editable" name="title" type="text" value="{{post.title}}"
                        placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”." readonly>
                </div>
                <div class="field">
                    <label class="label">ì‘ì„±ì</label>
                    <input class="input" name="author" type="text" value="{{post.author}}" readonly>
                </div>
                <div class="field">
                    <label class="label">ëª¨ì§‘ì¸ì›</label>
                    <input class="input editable" name="required" type="number" value="{{post.required}}"
                        placeholder="ì˜ˆ: 5" readonly>
                </div>
                <div class="field">
                    <label class="label">ì¡°íšŒìˆ˜</label>
                    <input class="readonly" name="viewcount" type="text" value="{{post.viewcount}}" readonly>
                </div>
                <div class="field">
                    <label class="label">ë§ˆê°ì¼</label>
                    <input class="date editable" name="closing_date" type="date" value="{{post.closing_date}}" readonly>
                    <input class="editable" type="time" name="closing_time" value="{{post.closing_time}}" readonly>
                </div>
                <div class="field">
                    <label class="label">ì‹œì‘ì¼</label>
                    <input class="date editable" name="start_date" type="date" value="{{post.start_date}}" readonly>
                    <input class="editable" type="time" name="start_time" value="{{post.start_time}}" readonly>
                </div>

            </div>
            <div>
                {%if post.runningPoints%}
                <div class="field" id="map">
                    {{post.runningPoints}}
                </div>
                {%endif%}
                {%if post.distance%}
                <div class="field">
                    <label class="label">ëŸ¬ë‹ ê±°ë¦¬</label>
                    <input class="input" name="author" type="text" value="{{post.distance}}" readonly>
                </div>
                {%endif%}
            </div>
            <div>
                {%if post.dest_lat%}
                <div class="field" id="map1">
                    {{post.dest_lat}}
                    {{post.dest_lng}}
                </div>
                <div class="field">
                    <label class="label">ëª©ì ì§€</label>
                    <input class="input" name="author" type="text" value="{{post.dest}}" readonly>
                </div>
                {%endif%}
            </div>
            <div>
                {%if post.taxi_fee%}
                <div class="field">
                    <label class="label">íƒì‹œ ëª©ì ì§€</label>
                    <span id="taxi_destination_text" name="taxi_dest_text"
                        style="display: none;">{{post.taxi_dest}}</span>
                    <div id="map2" style="height: 300px; margin-top: 10px;"></div>
                </div>
                <div class="field-container">
                    <div style="flex-grow: 1;"></div>
                </div>
                <div class="field">
                    <label class="label">ì˜ˆìƒ íƒì‹œë¹„</label>
                    <input class="input" name="author" type="text" value="{{post.taxi_fee}}ì›" readonly>
                </div>
                {%endif%}
            </div>

            <div class="editor">

                <label class="label">ë‚´ìš©</label>
                <textarea class="textarea editable" name="content" readonly>{{post.content}}</textarea>
            </div>

            {% if participants %}
            <table class="table table-bordered" style="text-align: center; margin-top: 1rem;">
                <tr>
                    <td>
                        ì°¸ì—¬ì
                    </td>
                    <td>
                        ì°¸ì„ì¼
                    </td>
                </tr>
                {%for participant in participants%}
                <tr style="vertical-align: middle;">
                    <td>
                        {{participant.user_id}}
                    </td>
                    <td>
                        {{participant.participated_time}}
                    </td>
                </tr>
                {%endfor%}
            </table>
            {% else %}
            <div class="alert alert-secondary" style="text-align: center; margin-top: 1rem;" role="alert">
                ì°¸ì—¬ìê°€ ì—†ìŠµë‹ˆë‹¤.
            </div>
            {% endif %}

            <div class="form-actions">
                <button class="btn btn-ghost" type="button" onclick="goMain();">ëª©ë¡ìœ¼ë¡œ</button>
                {% if post.statu == 1 %}
                {% if isMyPost %}
                <button class="btn btn-solid" type="button" onclick="doUpdate();">ìˆ˜ì •í•˜ê¸°</button>
                <button class="btn btn-solid" type="button" onclick="doClose();">ë§ˆê°í•˜ê¸°</button>
                {% elif alreadyApply %}
                <button class="btn btn-solid" type="button" onclick="doCancel();">ì·¨ì†Œí•˜ê¸°</button>
                {% else %}
                <button class="btn btn-solid" type="button" onclick="doApply();">ì°¸ì—¬í•˜ê¸°</button>
                {% endif %}
                {% endif %}
            </div>
            {% if replies %}
            <table class="table table-bordered" id="replyTable" style="text-align: center; margin-top: 1rem;">
                <thead>
                    <tr>
                        <td>
                            ì‘ì„±ì
                        </td>
                        <td>
                            ëŒ“ê¸€
                        </td>
                        <td>
                            ì‘ì„±ì¼
                        </td>
                    </tr>
                </thead>
                {%for reply in replies%}
                <tbody>
                    <tr style="vertical-align: middle;">
                        <td>
                            {{reply.user_id}}
                        </td>
                        <td>
                            {{reply.replyContent}}
                        </td>
                        <td>
                            {{reply.created_at}}
                        </td>
                    </tr>
                </tbody>
                {%endfor%}
            </table>
            {% else %}
            <div class="alert alert-secondary" style="text-align: center; margin-top: 1rem;" role="alert">
                ì‘ì„±ëœ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.
            </div>
            {% endif %}

            <div class="editor">
                <label class="label">ëŒ“ê¸€</label>
                <textarea class="textarea editable" id="reply_content" style="min-height: 0;"></textarea>
            </div>
            <div class="form-actions">
                <button class="btn btn-solid" type="button" onclick="doReply();">ëŒ“ê¸€ ì‘ì„±</button>
            </div>
        </form>


    </div>

</body>

</html>